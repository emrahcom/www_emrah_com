<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="tr" lang="tr">
<head>
<meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
<title>multimedia_notlari_wheezy.txt</title>
</head>
<body>
<pre><code>
# -----------------------------------------------------------------------------
# DEB-MULTIMEDIA DEPOSU
# -----------------------------------------------------------------------------

# /etc/apt/sources.list
deb http://www.deb-multimedia.org wheezy main non-free
deb-src http://www.deb-multimedia.org wheezy main non-free

# Keyring
aptitude update
aptitude install deb-multimedia-keyring
aptitude update


# -----------------------------------------------------------------------------
# FFMPEG
# -----------------------------------------------------------------------------

# Kurulum
aptitude install ffmpeg

# İzleme
ffplay -i test.avi

# Sadece ses kanalını izleme
ffplay -f alsa -ac 2 -i hw:0,0
ffplay -f alsa -ac 2 -i default

# Webcam izleme
ffplay  -loglevel quiet -v quiet \
-f video4linux2 -video_size 320x240 -vb 1024k -i /dev/video0


# Kaynaklar
http://ffmpeg.org/trac/ffmpeg/wiki/x264EncodingGuide



# -----------------------------------------------------------------------------
# MENCODER
# -----------------------------------------------------------------------------

# Kurulum
aptitude install mencoder

# Video capture kartından ve ses kartında yayını alıp kaydetme.
#WIDTH=720
#HEIGHT=480
WIDTH=1024
HEIGHT=600
VBITRATE=$((50 * 25 * $WIDTH * $HEIGHT / 256))

mencoder -nocache -aspect 16:9 tv:// \
-tv driver=v4l2:device=/dev/video0:input=0:normid=5:\
mjpeg:decimation=1:quality=80:\
alsa:adevice=hw.0:forceaudio:audiorate=48000:amode=1:immediatemode=0 \
-ovc lavc -lavcopts vcodec=mpeg4:vhq:vbitrate=$VBITRATE:autoaspect \
-oac copy \
-o test.avi

# Yayını pipe ile aktarma
Sadece son satır değişecek

-o - -really-quiet |



# -----------------------------------------------------------------------------
# MPLAYER &amp;&amp; SMPLAYER
# -----------------------------------------------------------------------------

mplayer2 ve smplayer2 paketleri, daha eski ffmpeg kodlarını kullandığı için
performansta düşüklük görüldü.

Video izlerken bazı durumlarda ffplay daha iyi netice vermekte.

# Kurulum
aptitude install mplayer smplayer

# Raspberry Pi izleme
mplayer -nocache -aspect 16:9 \
tv:// -tv driver=v4l2:device=/dev/video0:input=0:normid=0



# -----------------------------------------------------------------------------
# TVTIME
# -----------------------------------------------------------------------------

# Kurulum
aptitude install tvtime

# Izleme
tvtime

# Seste sorun çıkarsa ffplay ile ses kanalını dinle
ffplay -f alsa -ac 2 -i hw:0,0



# -----------------------------------------------------------------------------
# ALSA
# -----------------------------------------------------------------------------

Pulseaudio, ses ve videoyu farklı kanallardan alırken senkron sorununa sebep
oluyor, yüklenmesin.

# Kurulum
aptitude install alsa-base alsa-utils

# Ses kartından grafik kartın HDMI çıktısına sesi embed etmek için
alsamixer ile ses kartı olarak HDMI seçilir. S/PDIF &quot;M&quot; tuşuna basılarak aktif
hale getirilir.

# Line in'den ses alınırken iyi sonuç veren bazı ayarlar:
        Playback
                Master          -&gt; 80
                Headphone       -&gt; 80
                PCM             -&gt; 80
                Front           -&gt; 80
                Front mic       -&gt; MM
                Surround        -&gt; 80
                Center          -&gt; 80
                LFE             -&gt; MM
                Line            -&gt; MM
                CD              -&gt; MM
                S/PDIF          -&gt; MM
                S/PDIF Defa     -&gt; MM
                Dynamic Pow     -&gt; Disabled
                Independent     -&gt; OFF
                Loopback Mi     -&gt; Disabled
                Rear Mic        -&gt; MM
                Smart 5.1       -&gt; MM

        Capture
                Capture         -&gt; 0
                Capture 1       -&gt; 0
                Digital         -&gt; 50
                Input Source    -&gt; Line



# -----------------------------------------------------------------------------
# AVIDEMUX
# -----------------------------------------------------------------------------

# Kurulum
aptitude install avidemux avidemux-cli
aptitude install mjpegtools lame twolame


# -----------------------------------------------------------------------------
# NGINX RTMP
# -----------------------------------------------------------------------------

# Derleme icin gerekli paketler.
aptitude install dpkg-dev build-essential fakeroot


# Paketlerin alınması

mkdir source
cd source
mkdir nginx nginx_rtmp
cd nginx_rtmp
wget --no-check-certificate https://github.com/arut/nginx-rtmp-module/tarball/master
tar zxf master

cd ../nginx
apt-get source nginx-extras
cp -arp ../nginx_rtmp/arut-nginx-rtmp-module-* nginx-1.2.1/debian/modules/nginx-rtmp-module


# Derleme hazırlıkları

        - vim nginx-1.2.1/debian/rules
        config.status.extras
                ...
                ...
                # satir 170
                --add-module=$(MODULESDIR)/nginx-rtmp-module \

        - build-dep
        su -
        aptitude install libexpat1-dev liblua5.1-0-dev
        aptitude build-dep nginx-extras
        aptitude install libavcodec-dev libavformat-dev libavutil-dev
        exit


# Derleme

cd nginx-1.2.1/
dpkg-buildpackage -rfakeroot -uc -b
cd ..
su
dpkg -i nginx-common_1.2.1-2.2_all.deb
dpkg -i nginx-extras_1.2.1-2.2_i386.deb
aptitude hold nginx-common nginx-extras


# Nginx ayarları

        - /etc/nginx/nginx.conf
                rtmp {
                        server {
                                listen 1935;

                                application live {
                                        live on;
                                        allow publish 127.0.0.1;
                                        deny publish all;
                                        allow play all;

                                        hls on;
                                        hls_path /tmp/live;
                                        hls_fragment 5s;
                                }
                        }
                }

        - /etc/nginx/sites-available/default
                location /hls {
                        alias /tmp/live;
                }

        - tmpfs altında hls path
                mkdir /tmp/live
                chown www-data: /tmp/live

        - restart
                /etc/init.d/nginx configtest
                /etc/init.d/nginx restart



# Stream gönderme

ffmpeg -i mmsh://85.111.3.55/ntv \
-threads 0 -vprofile baseline -preset medium \
-c:v libx264 -b:v 256k -maxrate 256k -bufsize 512k \
-strict experimental -c:a aac -r:a 48000 -b:a 64k \
-f flv rtmp://localhost:1935/live/yayin1


# İzleme
ffplay rtmp://localhost:1935/live/yayin1
ffplay http://localhost/hls/yayin1.m3u8


# Kaynaklar
https://github.com/arut/nginx-rtmp-module
http://rarut.wordpress.com/



# -----------------------------------------------------------------------------
# KOMUTLARIN BİRLİKTE KULLANIMI
# -----------------------------------------------------------------------------

# Video ve ses kanallarını alıp RTMP sunucuya gönderme

#!/bin/bash
ASPECT=&quot;16:9&quot;
WIDTH=1280
HEIGHT=600
VBITRATE=$((50 * 25 * $WIDTH * $HEIGHT / 256))
DEVICE=&quot;/dev/video0&quot;
NORMID=5

mencoder -nocache -aspect $ASPECT tv:// \
-tv driver=v4l2:device=$DEVICE:input=0:normid=$NORMID:\
mjpeg:decimation=1:quality=60:\
alsa:adevice=hw.0:forceaudio:audiorate=48000:amode=1:immediatemode=0 \
-ovc lavc -lavcopts vcodec=mpeg4:vhq:vbitrate=$VBITRATE:autoaspect \
-oac copy \
-o - -really-quiet | \
ffmpeg  -re -i - -threads 0 \
-c:v libx264 -profile:v baseline -preset slow \
-b:v 512k -maxrate 512k -bufsize 1024k -aspect $ASPECT \
-strict experimental -c:a aac -ac 2 -ar 48000 -ab 64k \
-f flv rtmp://localhost:1935/live/yayin1


# ffplay ile pipe üzerinden izleme local'de izleme

#!/bin/bash
ASPECT=&quot;16:9&quot;
WIDTH=1920
HEIGHT=1080
VBITRATE=$((50 * 25 * $WIDTH * $HEIGHT / 256))
DEVICE=&quot;/dev/video0&quot;
NORMID=5

mencoder -nocache -aspect $ASPECT tv:// \
-tv driver=v4l2:device=$DEVICE:input=0:normid=$NORMID:\
alsa:adevice=hw.0:forceaudio:audiorate=48000:amode=1:immediatemode=0 \
-ovc lavc -lavcopts vcodec=mpeg4:vhq:vbitrate=$VBITRATE:autoaspect \
-oac copy \
-o - -really-quiet | \
ffmpeg  -re -i - -threads 0 \
-c:v libx264 -profile:v baseline -preset ultrafast \
-strict experimental -c:a aac -ac 2 -r:a 48000 -b:a 96k \
-f flv pipe:1 | \
ffplay -f flv -i -


# Sesin, mencoder tarafından işlenmesi istenmiyorsa...

#!/bin/bash
ASPECT=&quot;16:9&quot;
WIDTH=1920
HEIGHT=1080
VBITRATE=$((50 * 25 * $WIDTH * $HEIGHT / 256))
DEVICE=&quot;/dev/video0&quot;
NORMID=5

mencoder -nocache -aspect $ASPECT tv:// \
-tv driver=v4l2:device=$DEVICE:input=0:normid=$NORMID:\
-ovc lavc -lavcopts vcodec=mpeg4:vhq:vbitrate=$VBITRATE:autoaspect \
-nosound \
-o - -really-quiet | \
ffmpeg  -re -i - \
-f alsa -i default \
-threads 0 \
-vcodec libx264 -vprofile baseline -preset medium \
-b:v 512k -maxrate 512k -bufsize 1024k -aspect $ASPECT \
-strict experimental -c:a aac -ac 2 -r:a 48000 -b:a 64k \
-f flv rtmp://localhost:1935/live/yayin1



# -----------------------------------------------------------------------------
# AMAZON EC2
# -----------------------------------------------------------------------------

# Debian Wheezy makine
        Ireland
        ami-d81b12ac
        379101102735/debian-wheezy-amd64-20130208
        Default user: admin
</code></pre>
</body>
</html>