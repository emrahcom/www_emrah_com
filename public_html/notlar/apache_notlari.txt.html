<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="tr" lang="tr">
<head>
<title>apache_notlari.txt</title>
<meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
</head>
<body>
<pre><code>
Apache Notları
--------------

- Kurulum
	# PHP ile kullanilacaksa
	aptitude install apache2-mpm-prefork libapache2-mod-php5

	# Thread sorunu olmayan bir dil ile kullanılacaksa
	aptitude install apache2-mpm-worker


- Ayarlar
	# Ayarların doğruluğunun testi
	restart veya reload yapmadan önce ayarların doğruluğu test edilsin.
		apachectl configtest
		/etc/init.d/apache2 reload

	# Yoğun sunucularda apache2-mpm-prefork için

	curl site.com | grep &quot;src=&quot; | wc -l ile bir bağlantıda yaklaşık
	kaç adet istek olabileceğini tahmin et. Buna göre MaxKeepAliveRequests
	değerini belirle.

	ps aux | grep apache2 ile RSS satırına bakıp her bağlantı için fiziksel
	hafızadan yaklaşık kaç KB kullanıldığını kontrol et. 
	[Apacheye_ayrilan_RAM] / [RSS_degeri] formülü ile MaxClients değerinin
	kaç olabileceğini tahmin et.

	MaxClients 256'dan büyük olacaksa ServerLimit değerini ona eşitle.


	/etc/apache2/apache2.conf
		Timeout 45
		KeepAlive On
		MaxKeepAliveRequests 256

		&lt;IfModule mpm_prefork_module&gt;
		    StartServers            5
		    MinSpareServers        10
		    MaxSpareServers       100
		    ServerLimit           512
		    MaxClients            512
		    MaxRequestsPerChild   500
		&lt;/IfModule&gt;

	/etc/security/limits.conf
		www-data         hard    nofile          65536
		www-data         soft    nofile          65536


	# Güvenlik
	/etc/apache2/conf.d/security
		ServerTokens Prod
		ServerSignature Off
		TraceEnable Off


	# Dosya tipine göre cache süreleri
	cd /etc/apache2/mods-enabled
	ln -s ../mods-available/expires.load .

	/etc/apache2/sites-enables/ilgili_dosya
		&lt;Directory ...&gt;
			...

			&lt;IfModule mod_expires.c&gt;
				ExpiresActive on
				ExpiresDefault &quot;access plus 4 hours&quot;
				ExpiresByType image/jpeg &quot;access plus 30 days&quot;
				ExpiresByType image/jpg &quot;access plus 30 days&quot;
				ExpiresByType image/gif &quot;access plus 30 days&quot;
				ExpiresByType image/png &quot;access plus 30 days&quot;
				ExpiresByType image/bmp &quot;access plus 30 days&quot;
				ExpiresByType text/css &quot;access plus 30 days&quot;
				ExpiresByType text/html &quot;access plus 30 seconds&quot;
				ExpiresByType text/xml &quot;access plus 45 seconds&quot;
				ExpiresByType text/plain &quot;access plus 60 seconds&quot;
				ExpiresByType text/javascript &quot;modification plus 30 days&quot;
				ExpiresByType application/javascript &quot;access plus 30 days&quot;
				ExpiresByType application/x-javascript &quot;access plus 30 days&quot;
				ExpiresByType application/x-shockwave-flash &quot;access plus 30 days&quot;
			&lt;/IfModule&gt;
		&lt;/Directory&gt;

	Expire zamanını ve sayfanın header bilgilerini görmek için:
	curl --head http://www.emrah.com/resim.jpg


- ApacheTop
	aptitude install apachetop libgamin0


- Nginx: reverse proxy
  Yoğun sitelerde Apache önüne Nginx, reverse proxy olarak konulabilir.

	# Ayarları değiştirdikten sonra yeni ayarları kullanmadan önce doğruluğunu test et.
		/etc/init.d/nginx configtest

	/etc/nginx/nginx.conf
		worker_processes		# CPU sayisi kadar olacak.
						# Tek islemcili makinede latency'yi azaltmak icin 2 veya 4 denenebilir.
		worker_rlimit_nofile 32768;	# limits.conf'daki nofile degerini asmasin.

		events {
			worker_connections  8192;	# process basina maksimum baglanti sayisi.
							# reverse proxy oldugunda x/4 eszamanli kisi baglanabilir.
							# Genelde kisi basina 2 connection ve 2 de backend web sunucu icin.

		http {
			client_max_body_size 16M;	# maksimum upload boyu icin gerekli.

			server_tokens off;		# Sunucu hakkinda bilgi vermesin
			proxy_hide_header X-Powered-By;
			proxy_hide_header X-AspNet-Version;


	/etc/nginx/sites-enabled/default
		# Yonlendirme: domain.com -&gt; www.domain.com
		server {
			listen          80;
			server_name     domain.com;
			rewrite &circ;/(.*) http://www.domain.com/$1 permanent;
		}

		server {
			listen          80;
			listen          [::]:80 default ipv6only=on;

			server_name     www.domain.com;
			root            /var/www;
			access_log      /var/log/nginx/access.log;

			proxy_cache_path  /var/cache/nginx levels=1:2 keys_zone=cache1:10m max_size=200m inactive=600m;
			proxy_temp_path /var/cache/nginx/tmp;

			# /istatistik icin alias
			location &tilde; &circ;/istatistik($|/.*) {
				proxy_pass              http://localhost:8080;
				alias                   /var/www/istatistik$1;
			}

			# Tasarimla ilgili statik dosyalarini dogrudan gonder, expire suresi kisa
			location &tilde;* &circ;.+\.(css|js|xml|rss)$ {
				access_log off;
				expires 60s;
			}

			# Resim dosyalarini dogrudan gonder
			location &tilde;* &circ;.+\.(jpg|jpeg|gif|png|ico|bmp)$ {
				gzip off;
				access_log off;
				expires 30d;
			}

			# Uygulama dosyalarini dogrudan gonder
				location &tilde;* &circ;.+\.(zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|txt|tar|rtf)$ {
				access_log off;
				expires 30d;
			}

			# Video/ses dosyalarini dogrudan gonder
			location &tilde;* &circ;.+\.(mp3|mp4|avi|flv|swf|mid|midi|wav|bmp)$ {
				gzip off;
				access_log off;
				expires 30d;
			}

			# Diger dosyalari backend sunucudan (Apache'den) al
			location / {
				proxy_pass              http://localhost:8080;
				proxy_set_header        X-Real-IP  $remote_addr;
				proxy_set_header        Host $host;
				proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_cache		cache1
				proxy_cache_valid	200 302  5m;
				proxy_cache_use_stale   error timeout invalid_header updating http_500 http_502 http_504 http_404;
			}

			# Backend sunucudan alinip cachede bir sure tutulacak dosyalar
			location  &tilde;* &circ;\/haberler\/.+\.(htm|html|php)$ {
				proxy_pass              http://localhost:8080;
				proxy_set_header        X-Real-IP  $remote_addr;
				proxy_set_header        Host $host;
				proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_ignore_headers    X-Accel-Expires Expires Cache-Control;
				proxy_cache             one;
				proxy_cache_valid       200 302  60s;
				proxy_cache_use_stale   error timeout invalid_header updating http_500 http_502 http_504 http_404;
				proxy_ignore_headers	Expires Cache-Control;
				expires                 60s;
			}
		}

		server {
			listen          80;
			listen          [::]:80;

			server_name     static.domain.com;
			root            /var/www/static;
			access_log      /var/log/nginx/access.log;

			# Diger dosyalari backend sunucudan (Apache'den) al
			location / {
				access_log off;
				expires 30d;
			}
		}

	# Location direktifi
		# Literal string match. Host adindan sonra gelen kismin
		# bas tarafi ile eslestirir. En uygun locationi bulana
		# kadar aramaya devam eder.
		location / { }
		location /media/ { }
		location /media/video/ { }
		location /media/voice/ { }

		# Literal string match. Uyan location bulundugunda
		# aramayi birakir.
		location &circ;&tilde; /media/ { }

		# Exact string match. Location taniminin tam uymasi gerekir.
		# Uygun location bulundugunda aramayi birakir.
		location = / { }

		# Case-sensitive regex
		location &tilde; &circ;/Media(/|/index\.html)$ { }
		location &tilde; &circ;/media(/|/index\.html)$ { }

		# Case-insensitive regex
		location &tilde;* &circ;/media(/|/index\.html)$ { }


		# location oncelikleri
			. Öncelikle &quot;exact string match&quot; var mi diye bakılır. Varsa
			arama bitirilir.

			. Literal string match için bakılır. &circ;&tilde; kullanıldıysa eşleşen
			bir location bulundu ise arama bırakılır. Kullanılmadıysa
			locationlara bakılmaya devam edilir.

			. Regex araması yapılır. Uyan bir regex varsa arama bırakılır.

			. Uyan regex çıkmadıysa literal string match ile bulunan en uygun
			location kullanılır.


- awstats: web istatistikleri

	# Kurulum
	aptitude install awstats	
	aptitude install libgeo-ip-perl libgeoip1 geoip-database


	# Ayarlar dosyası
	/etc/awstats/awstats.conf
		LogFile=&quot;/home/awstats/access_merged.log&quot;
		LogFormat=1
		SiteDomain=&quot;Emrah&quot;
		HostAliases=&quot;www.emrah.com localhost 127.0.0.1&quot;
		DNSLookup=0
		LoadPlugin=&quot;geoip GEOIP_STANDARD /usr/share/GeoIP/GeoIP.dat&quot;
		Lang=&quot;en&quot;


	# Apache ayarları
	vim /etc/apache2/sites-enabled/000-default
		# awstats
		Alias /awstats &quot;/var/www/awstats&quot;
		ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
		&lt;Directory &quot;/usr/lib/cgi-bin&quot;&gt;
			AllowOverride None
			Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
			Order allow,deny
			Allow from all
		&lt;/Directory&gt;

		# awstats icin parola gerekiyor
		&lt;FilesMatch &quot;awstats.pl&quot;&gt;
			AuthName &quot;Guvenli Giris&quot;
			AuthType Basic
			AuthUserFile /home/www-data/htaccess
			require valid-user
		&lt;/FilesMatch&gt;

		# awstats icon
		Alias /awstats-icon/ /usr/share/awstats/icon/
		&lt;Directory /usr/share/awstats/icon&gt;
		    Options None
		    AllowOverride None
		    Order allow,deny
		    Allow from all 
		&lt;/Directory&gt;


	# Web sayfası
	/var/www/awstats/index.html
		&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
		&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;
		&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;
		&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
		&lt;head&gt;
		&lt;meta HTTP-EQUIV=&quot;REFRESH&quot; content=&quot;0; url=/cgi-bin/awstats.pl&quot;&gt;
		&lt;/head&gt;
		&lt;body&gt;
		&lt;a href=&quot;/cgi-bin/awstats.pl&quot;&gt;awstats&lt;/a&gt;
		&lt;/html&gt;


	# Nginx ve Apache loglarını birleştirme
	Bu klasor ve dosyalar root'a ait
	/home/awstats/awstats_merge.sh
		#!/bin/bash
		MERGE=&quot;/usr/share/awstats/tools/logresolvemerge.pl&quot;
		DIR=&quot;/home/awstats&quot;
		LOG_APACHE=&quot;/var/log/apache2/access.log&quot;
		LOG_NGINX=&quot;/var/log/nginx/access.log&quot;

		cp $LOG_APACHE $DIR/access_apache.log
		cp $LOG_NGINX $DIR/access_nginx.log
		$MERGE $DIR/access_apache.log $DIR/access_nginx.log &gt;$DIR/access_merged.log.tmp
		mv $DIR/access_merged.log.tmp $DIR/access_merged.log

	/etc/crontab
		25 * * * * root /home/awstats/awstats_merge.sh &gt;/dev/null 2&gt;&amp;
</code></pre>
</body>
</html>