<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="tr" lang="tr">
<head>
<meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
<title>postgresql_notlari.txt</title>
</head>
<body>
<pre><code>
-------------------------------------------------------------------------------
PostgreSQL Notları
-------------------------------------------------------------------------------

- Yükleme
        aptitude install postgresql postgresql-contrib
        aptitude install python-psycopg2 postgresql-plpython-8.4


- Yönetici paneli olacaksa...
        aptitude install pgadmin3 pgagent phppgadmin
        su -l
        su -l postgres
        psql template1 &lt; /usr/share/postgresql/8.4/contrib/adminpack.sql


- Default klasörün değiştirilmek istenirse...
        su -l
        mkdir /home/pgsql
        chmod 700 /home/pgsql
        chown postgres: /home/pgsql

        /etc/init.d/postgresql stop
        cp -arp /var/lib/postgresql/8.4/main/* /home/pgsql/

        vim /etc/postgresql/8.4/main/postgresql.conf
                #data_directory = '/var/lib/postgresql/8.4/main'
                data_directory = '/home/pgsql'

        /etc/init.d/postgresql start


- İlk çalıştırma
        su -l
        su -l postgres
        psql


- Kullanıcı tanımlama ve yetkilendirme
        # Default olarak sadece postgres kullanıcısı tanımlı ve UNIX socket
        ile bağlanabiliyor. Yerel postgres kullanıcısının parolası
        değiştirilsin.
                su -l
                passwd postgres

        # postgres kullanıcısının ağdan da bağlanabilmesi isteniyorsa
                su -l postgres
                psql
                \password postgres

        # Yeni ağ kullanıcısı tanımlama
                CREATE ROLE kullanici;
                ALTER ROLE kullanici WITH LOGIN;
                \password kullanici

        # Sadece bir tabloda okuma yetkisi olan ağ kullanıcısı tanımlama
                CREATE ROLE okuyucu;
                ALTER ROLE okuyucu WITH LOGIN;
                \password okuyucu
                \c veritabani
                GRANT SELECT ON TABLE tablo TO okuyucu;

        # Localhost dışında ağdaki hangi makinelerden bağlanılabileceği
        pg_hba.conf dosyasından tanımlanıyor. Bir kullanıcının ağdaki hangi
        makineden, hangi veritabanına bağlanabileceğini belirlemek için

                /etc/postgresql/8.4/main/pg_hba.conf
                host  veritabani  kullanici  192.168.2.103/32  md5

        # Yerel sistem kullanıcısına bağlanma yetkisi vermek için
                /etc/postgresql/8.4/main/pg_hba.conf
                local  veritabani  kullanici  ident


- Postgresql konsol komutları
        # SQL script dosyası çalıştırma
                psql -U kullanici -h localhost -d veritabani -f dosya.sql
                psql -U kullanici -h localhost -d veritabani &lt; dosya.sql
                cat dosya.sql | psql -U kullanici -h localhost -d veritabani

                su -l postgres
                psql -d veritabani &lt; dosya.sql
                psql -d veritabani -e &lt; dosya.sql  # echo commands

        # Komut çıktısını alma
                echo &quot;\l&quot; | psql
                psql -c &quot;\l&quot;
                psql -c &quot;SELECT version()&quot;
                cat dosya.sql | psql
                echo &quot;\l&quot; | psql -o dosya
                echo &quot;\l&quot; | psql &gt; dosya

        # Veritabanı dökümünü alma (pg_dump)
                pg_dump veritabani


- pgsql temel komutlar
        \q                      Çıkış
        \?                      Yardım
        \h                      SQL komutlarının listesi
        \h KOMUT                SQL komutu ile ilgili yardım
        \l                      Veritabanlarını listele
        \c VERITABANI           Veritabanina geçer
        \dt                     Tablo listesi
        \dtS                    Tablo listesi, sistem tablolari dahil
        \d NESNE                Tablo, view sequence, index için detay bilgi gösterme
        \dv                     View listesi
        \di                     Indeks listesi
        \dn                     Sema listesi
        \du                     Role/user listesi
        \dp                     Yetki (privileges) listesi
        \password KULLANICI     Kullanıcı parolasını değiştirir


- SQL notları
        - Serial, timestamp vb alanlar.
        CREATE TABLE sch.tablo (
                tablo_id        SERIAL PRIMARY KEY,
                tablo_foreign   INTEGER NOT NULL REFERENCES sch.tablo2(tablo2_pkey),
                tablo_kod       VARCHAR(50) NOT NULL UNIQUE,
                tablo_zaman     TIMESTAMP NOT NULL DEFAULT NOW(),
                tablo_timeout   TIMESTAMP NOT NULL DEFAULT NOW() + INTERVAL '15 minutes',
                tablo_captcha   VARCHAR(6) NOT NULL DEFAULT LPAD(TEXT(TRUNC(RANDOM()*1000000)), 6, '0')
        );

        - Default degeri kullanmak.
        UPDATE sch.tablo SET alan = DEFAULT ...
        INSERT INTO sch.tablo VALUES (DEFAULT, &quot;deger&quot;, ...

        - SQL sonrası oluşan değerleri almak.
        Değişen kayıt sayısı kadar kayıt geri döner.
        INSERT INTO sch.tablo VALUES (..) RETURNING (alan1, alan2);
        UPDATE sch.tablo SET alan1=DEFAULT RETURNING (alan1, alan2);

        - Serial alanın değerini, mevcut maksimum değere bakarak yeniden atama.
        SELECT SETVAL('field_id_seq', (SELECT MAX(field_id) FROM tablename));


- Psycopg notları
        - Modulun import edilmesi
                import psycopg2
                import psycopg2.extras

        - Bağlantı kurulması
                def get_connection():def get_connection():
                        try:
                                cstr = &quot;host=%s dbname=%s user=%s password=%s&quot; % \
                                        (PSQL_SERVER, PSQL_DB, PSQL_USER, PSQL_PASSWD)
                                cnn = psycopg2.connect(cstr)
                                crs = cnn.cursor(cursor_factory=psycopg2.extras.DictCursor)

                                result = (cnn, crs)
                        except Exception, err:
                                if DEBUG:
                                        raise
                                else:
                                        sys.stderr.write(str(err))

                                result = (None, None)

                        return result

                (cnn, crs) = get_connection()

        - Bağlantının kapatılması
                def close_connection(cnn, crs):
                        try:
                                # Cursori kapat.
                                try:
                                        crs.close()
                                except Exception, err:
                                        pass

                                # Veritabani baglantisini kapat.
                                try:
                                        cnn.close()
                                except Exception, err:
                                        pass

                                result = True
                        except Exception, err:
                                if DEBUG:
                                        raise
                                else:
                                        sys.stderr.write(str(err))

                                result = False

                        return result

                close_connection(cnn, crs)

        - SQL kodunun parametre ile çalıştırılması
                sql = &quot;SELECT * FROM tablo WHERE id = %s&quot;
                par = (1212, )
                crs.execute(sql, par)
                rows = crs.fetchall()

        - Çalıştırılan SQL'i parametreler yerlerine konulduktan sonraki şekli.
                print(crs.mogrify(sql, par))
</code></pre>
</body>
</html>